# koishi-plugin-bot

[![npm](https://img.shields.io/npm/v/koishi-plugin-bot?style=flat-square)](https://www.npmjs.com/package/koishi-plugin-bot)

## 简介

一个为 Koishi 机器人开发的趣味性插件，提供回声洞功能，支持文字、图片与视频的收藏与分享。

## 配置说明

在配置文件中可设置以下属性：

- manager：管理员列表（必填）
- blacklist：禁用用户列表
- number：调用冷却时间（单位：秒）
- enableAudit：是否启用审核流程
- allowVideo：是否允许添加视频
- videoMaxSize：视频最大上传大小（单位：MB）
- imageMaxSize：图片最大上传大小（单位：MB）

## 功能特性

### 回声洞系统 (cave)

#### 核心功能

- 支持文字与图片混合保存
- 智能处理各类图片链接
- 可选的视频内容支持
- 完整的权限管理系统
- 可选的内容审核流程
- 群组调用冷却机制

#### 基础指令

| 指令 | 说明 | 权限 |
|------|------|------|
| `cave` | 随机展示一条回声洞 | 所有人 |
| `cave -a <内容>` | 添加新回声洞（支持文字、图片与视频） | 所有人 |
| `cave -g <编号>` | 查看指定回声洞 | 所有人 |
| `cave -r <编号>` | 删除指定回声洞 | 内容贡献者/管理员 |

#### 管理指令

| 指令 | 说明 | 权限 |
|------|------|------|
| `cave -l [用户ID]` | 查看投稿统计 | 管理员 |
| `cave -p <编号/all>` | 通过待审核内容 | 管理员 |
| `cave -d <编号/all>` | 拒绝待审核内容 | 管理员 |

#### 注意事项

1. 图片以及视频会自动保存到本地，请确保存储空间充足。
2. 管理员不受群组冷却时间限制。
3. 开启审核模式后，新内容需要审核才能生效。
4. 引用消息添加支持保留原消息格式。
5. 配置文件中可分别调整是否允许添加视频，以及各自的文件大小限制。

#### 逻辑分析

1. 配置与初始化
   • 定义插件名称、依赖及配置 Schema，其中新增了允许视频和相关大小限制的配置项。
   • apply 函数中调用 initCavePaths 初始化各类路径（数据、回声洞 JSON、资源目录、待审核 JSON）。

2. 文件操作与媒体处理
   • readJsonData 和 writeJsonData 用于读写 JSON 文件。
   • ensureDirectory 与 ensureJsonFile 确保目录和文件存在，帮助初始化工作。
   • saveMedia 函数整合了对图片与视频的下载、大小校验和保存逻辑，通过传入 mediaType 参数区分处理方式。

3. 审核流程与消息构建
   • sendAuditMessage 用于向管理员推送待审核回声洞通知。
   • buildMessage 根据回声洞内容构建消息，图片通过 base64 编码嵌入，视频（如有）则单独发送，提升用户体验。

4. 主业务逻辑
   • 根据用户传入的不同参数，分别执行查询投稿、审核、查看、随机抽取、删除和添加回声洞操作。
   • processAdd 中解析用户输入支持内嵌 `<img>`、`<video>` 标签，下载对应媒体文件后合并到回声洞数据中。
